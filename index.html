<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>三角洲行动随机装备</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1a365d',
            secondary: '#162447',
            accent: '#fc814a',
            neon: '#00f7ff',
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .btn-touch {
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .glass {
        backdrop-filter: blur(10px);
        background: rgba(26, 54, 93, 0.6);
        border: 1px solid rgba(0, 247, 255, 0.15);
      }
      .glass-dark {
        backdrop-filter: blur(8px);
        background: rgba(15, 23, 42, 0.75);
      }
      .text-glow {
        text-shadow: 0 0 8px rgba(0, 247, 255, 0.6);
      }
      .card-hover {
        transition: all 0.2s ease;
      }
      .card-hover:active {
        transform: scale(0.98);
      }
    }
  </style>
</head>
<body class="text-white min-h-screen overflow-y-auto">
  <!-- 背景图 -->
  <div class="fixed inset-0 z-0">
    <img src="./beijing/beijing_01.png" alt="背景" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/40 to-black/70"></div>
  </div>

  <!-- 顶部装饰条 -->
  <div class="fixed top-0 left-0 right-0 h-1 bg-gradient-to-r from-neon via-accent to-neon z-30"></div>

  <!-- 可滚动内容区 -->
  <div class="relative z-10 p-5 pb-36">
    <!-- 标题区域 -->
    <div class="text-center mb-8 mt-2">
      <div class="inline-block mb-3">
        <i class="fa fa-crosshairs text-neon text-2xl text-glow"></i>
      </div>
      <h1 class="text-[clamp(1.6rem,8vw,2.4rem)] font-bold text-neon mb-2 text-glow tracking-wide">
        三角洲行动
      </h1>
      <p class="text-[clamp(1.1rem,5vw,1.5rem)] text-gray-200 mb-4">随机装备系统</p>
      
      <!-- 模式选择按钮组 -->
      <div class="flex gap-2 max-w-md mx-auto mb-1">
        <button onclick="setMode('random')" class="flex-1 glass text-white py-2.5 rounded-lg btn-touch text-sm" id="randomMode">
          随机模式
        </button>
        <button onclick="setMode('balanced')" class="flex-1 bg-neon text-primary py-2.5 rounded-lg btn-touch text-sm font-bold" id="balancedMode">
          均衡模式
        </button>
        <button onclick="setMode('aggressive')" class="flex-1 glass text-white py-2.5 rounded-lg btn-touch text-sm" id="aggressiveMode">
          猛攻模式
        </button>
      </div>
    </div>

    <!-- 装备展示区 -->
    <div class="space-y-6">
      <!-- 头盔 -->
      <div class="glass rounded-2xl p-5 card-hover">
        <div class="flex items-center mb-4">
          <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center mr-3 border border-neon/30">
            <i class="fa fa-shield text-neon"></i>
          </div>
          <h2 class="text-xl font-bold text-white">头盔</h2>
        </div>
        
        <div class="bg-black/30 rounded-xl overflow-hidden mb-5 aspect-[4/3] flex items-center justify-center border border-white/10">
          <img id="helmetImage" src="" alt="头盔" class="max-w-[85%] max-h-[85%] opacity-0 transition-opacity duration-300">
          <div id="helmetPlaceholder" class="text-center p-4">
            <i class="fa fa-helmet-battle text-5xl mb-3 text-gray-400/70"></i>
            <p class="text-gray-400/80 text-sm">点击下方按钮获取随机头盔</p>
          </div>
        </div>
        
        <button onclick="randomizeSingle('helmet', 25)" 
                class="w-full bg-secondary hover:bg-primary text-white py-3 rounded-xl btn-touch flex items-center justify-center"
                id="helmetBtn">
          <i class="fa fa-refresh mr-2"></i> 刷新头盔
          <span class="ml-2 bg-accent text-dark px-2.5 py-0.5 rounded-full text-xs font-bold" id="helmetCount">3次</span>
        </button>
      </div>
      
      <!-- 护甲 -->
      <div class="glass rounded-2xl p-5 card-hover">
        <div class="flex items-center mb-4">
          <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center mr-3 border border-neon/30">
            <i class="fa fa-user-shield text-neon"></i>
          </div>
          <h2 class="text-xl font-bold text-white">护甲</h2>
        </div>
        
        <div class="bg-black/30 rounded-xl overflow-hidden mb-5 aspect-[4/3] flex items-center justify-center border border-white/10">
          <img id="armorImage" src="" alt="护甲" class="max-w-[85%] max-h-[85%] opacity-0 transition-opacity duration-300">
          <div id="armorPlaceholder" class="text-center p-4">
            <i class="fa fa-shield-alt text-5xl mb-3 text-gray-400/70"></i>
            <p class="text-gray-400/80 text-sm">点击下方按钮获取随机护甲</p>
          </div>
        </div>
        
        <button onclick="randomizeSingle('armor', 25)" 
                class="w-full bg-secondary hover:bg-primary text-white py-3 rounded-xl btn-touch flex items-center justify-center"
                id="armorBtn">
          <i class="fa fa-refresh mr-2"></i> 刷新护甲
          <span class="ml-2 bg-accent text-dark px-2.5 py-0.5 rounded-full text-xs font-bold" id="armorCount">3次</span>
        </button>
      </div>
      
      <!-- 枪械 -->
      <div class="glass rounded-2xl p-5 card-hover">
        <div class="flex items-center mb-4">
          <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center mr-3 border border-neon/30">
            <i class="fa fa-crosshairs text-neon"></i>
          </div>
          <h2 class="text-xl font-bold text-white">枪械</h2>
        </div>
        
        <div class="bg-black/30 rounded-xl overflow-hidden mb-5 aspect-[4/3] flex items-center justify-center border border-white/10">
          <img id="gunImage" src="" alt="枪械" class="max-w-[85%] max-h-[85%] opacity-0 transition-opacity duration-300">
          <div id="gunPlaceholder" class="text-center p-4">
            <i class="fa fa-firearms text-5xl mb-3 text-gray-400/70"></i>
            <p class="text-gray-400/80 text-sm">点击下方按钮获取随机枪械</p>
          </div>
        </div>
        
        <button onclick="randomizeSingle('gun', 59)" 
                class="w-full bg-secondary hover:bg-primary text-white py-3 rounded-xl btn-touch flex items-center justify-center"
                id="gunBtn">
          <i class="fa fa-refresh mr-2"></i> 刷新枪械
          <span class="ml-2 bg-accent text-dark px-2.5 py-0.5 rounded-full text-xs font-bold" id="gunCount">3次</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- 底部功能区 -->
  <div class="fixed bottom-0 left-0 right-0 z-20 p-5 bg-gradient-to-t from-black/90 via-black/60 to-transparent">
    <!-- 主按钮 -->
    <button onclick="randomizeAll()" 
            class="w-full bg-accent hover:bg-accent/90 text-dark font-bold py-3.5 rounded-2xl btn-touch flex items-center justify-center text-base relative mb-4 shadow-lg shadow-accent/20"
            id="allBtn">
      <i class="fa fa-random mr-2"></i> 随机全部装备
      <span class="ml-2 bg-dark text-white px-2.5 py-0.5 rounded-full text-xs font-bold" id="allCooldown">30s</span>
    </button>
    
    <!-- 辅助按钮组 -->
    <div class="flex gap-3">
      <button onclick="showRulesModal()" class="flex-1 glass-dark text-white py-3 rounded-xl btn-touch text-sm">
        <i class="fa fa-info-circle mr-1.5"></i> 使用说明
      </button>
      <button onclick="showAdminModal()" class="flex-1 glass-dark text-white py-3 rounded-xl btn-touch text-sm">
        <i class="fa fa-key mr-1.5"></i> 重置冷却
      </button>
    </div>
  </div>

  <!-- 规则模态框 -->
  <div id="rulesModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-5 hidden">
    <div class="glass-dark rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto border border-gray-700/50">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-xl font-bold text-neon text-glow">使用规则</h3>
        <button onclick="hideRulesModal()" class="text-gray-400 hover:text-white">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4 text-sm text-gray-200">
        <div>
          <h4 class="text-accent font-bold mb-2 flex items-center">
            <i class="fa fa-cube mr-2"></i>装备类型
          </h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>头盔（25种不同款式）</li>
            <li>护甲（25种不同款式）</li>
            <li>枪械（59种不同款式）</li>
          </ul>
        </div>
        
        <div>
          <h4 class="text-accent font-bold mb-2 flex items-center">
            <i class="fa fa-sliders mr-2"></i>模式说明
          </h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>随机模式：所有装备概率均等</li>
            <li>均衡模式：中间等级装备概率更高</li>
            <li>猛攻模式：高等级装备概率更高</li>
          </ul>
        </div>
        
        <div>
          <h4 class="text-accent font-bold mb-2 flex items-center">
            <i class="fa fa-clock-o mr-2"></i>使用限制
          </h4>
          <ul class="list-disc pl-6 space-y-1">
            <li>单个装备类型每小时可刷新3次</li>
            <li>全部装备刷新有30秒冷却时间</li>
          </ul>
        </div>
      </div>
      
      <button onclick="hideRulesModal()" class="mt-6 w-full bg-accent text-dark py-3 rounded-xl font-bold">
        明白了
      </button>
    </div>
  </div>

  <!-- 管理员模态框 -->
  <div id="adminModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-5 hidden">
    <div class="glass-dark rounded-2xl p-6 max-w-md w-full border border-gray-700/50">
      <h3 class="text-xl font-bold text-neon text-glow mb-5 text-center">管理员验证</h3>
      
      <input type="password" id="adminPassword" placeholder="请输入管理员密码" 
             class="w-full bg-secondary border border-gray-700 rounded-xl p-3 mb-4 text-white focus:outline-none focus:border-neon/50">
      
      <div class="flex gap-3">
        <button onclick="verifyPassword()" class="flex-1 bg-accent text-dark py-3 rounded-xl font-bold">
          确认
        </button>
        <button onclick="hideAdminModal()" class="flex-1 bg-gray-700/50 text-white py-3 rounded-xl">
          取消
        </button>
      </div>
      
      <p id="passwordError" class="text-red-500 text-xs mt-3 text-center hidden">
        密码错误，请重新输入
      </p>
    </div>
  </div>

  <script>
    let currentMode = 'balanced';
    let updateTimer = null;
    
    // 初始化存储
    function initStorage() {
      const now = Date.now();
      const hourMs = 3600000; // 1小时毫秒数
      
      // 初始化单个装备冷却数据
      ['helmet', 'armor', 'gun'].forEach(type => {
        const storedKey = `cooldown_${type}`;
        let data;
        
        try {
          data = JSON.parse(localStorage.getItem(storedKey));
        } catch (e) {
          data = null;
        }
        
        // 检查数据有效性或不存在
        if (!data || typeof data.count !== 'number' || typeof data.resetTime !== 'number' || now > data.resetTime) {
          const initData = { count: 3, resetTime: now + hourMs };
          localStorage.setItem(storedKey, JSON.stringify(initData));
        }
      });
      
      // 初始化全部装备冷却数据
      if (!localStorage.getItem('allLastUsed')) {
        localStorage.setItem('allLastUsed', '0');
      }
      
      updateButtonStates();
      scheduleNextUpdate();
    }
    
    // 格式化剩余时间显示
    function formatRemainingTime(ms) {
      const hours = Math.floor(ms / 3600000);
      const minutes = Math.floor((ms % 3600000) / 60000);
      const seconds = Math.floor((ms % 60000) / 1000);
      
      if (hours > 0) {
        return `${hours}时${minutes}分`;
      } else if (minutes > 0) {
        return `${minutes}分${seconds}秒`;
      } else {
        return `${seconds}秒`;
      }
    }
    
    // 更新按钮状态
    function updateButtonStates() {
      const now = Date.now();
      
      // 更新单个按钮
      ['helmet', 'armor', 'gun'].forEach(type => {
        const storedKey = `cooldown_${type}`;
        let data;
        try {
          data = JSON.parse(localStorage.getItem(storedKey));
        } catch (e) {
          data = { count: 0, resetTime: now }; // 防止崩溃，设为无效状态
        }
        
        // 确保数据有效性
        if (!data || typeof data.count !== 'number' || typeof data.resetTime !== 'number') {
          data = { count: 3, resetTime: now + 3600000 };
          localStorage.setItem(storedKey, JSON.stringify(data));
        }

        const btn = document.getElementById(`${type}Btn`);
        const countEl = document.getElementById(`${type}Count`);
        
        // 计算剩余时间，确保非负
        const remainingMs = Math.max(0, data.resetTime - now);
        
        if (data.count > 0) {
          countEl.textContent = `${data.count}次`;
          btn.disabled = false;
          btn.classList.remove('opacity-60', 'cursor-not-allowed');
        } else if (remainingMs > 0) {
          // 次数用完，显示倒计时
          countEl.textContent = formatRemainingTime(remainingMs);
          btn.disabled = true;
          btn.classList.add('opacity-60', 'cursor-not-allowed');
        } else {
          // 倒计时结束，重置次数
          data.count = 3;
          data.resetTime = now + 3600000;
          localStorage.setItem(storedKey, JSON.stringify(data));
          countEl.textContent = '3次';
          btn.disabled = false;
          btn.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      });
      
      // 更新全部按钮
      const allLastUsed = parseInt(localStorage.getItem('allLastUsed') || '0');
      const allBtn = document.getElementById('allBtn');
      const allCooldownEl = document.getElementById('allCooldown');
      
      if (now - allLastUsed < 30000) { // 30秒内
        const remaining = Math.ceil((30000 - (now - allLastUsed)) / 1000);
        allBtn.disabled = true;
        allBtn.classList.add('opacity-60', 'cursor-not-allowed');
        allCooldownEl.textContent = `${remaining}s`;
      } else {
        allBtn.disabled = false;
        allBtn.classList.remove('opacity-60', 'cursor-not-allowed');
        allCooldownEl.textContent = '30s';
      }
    }
    
    // 智能调度下一次更新
    function scheduleNextUpdate() {
      if (updateTimer) clearTimeout(updateTimer);
      
      const now = Date.now();
      const nextUpdate = Math.ceil(now / 1000) * 1000; // 下一个整秒
      const delay = nextUpdate - now;
      
      updateTimer = setTimeout(() => {
        updateButtonStates();
        scheduleNextUpdate(); // 递归调度
      }, delay);
    }
    
    // 模式切换
    function setMode(mode) {
      currentMode = mode;
      
      ['random', 'balanced', 'aggressive'].forEach(m => {
        const btn = document.getElementById(`${m}Mode`);
        if (m === mode) {
          btn.classList.remove('glass', 'text-white');
          btn.classList.add('bg-neon', 'text-primary', 'font-bold');
        } else {
          btn.classList.remove('bg-neon', 'text-primary', 'font-bold');
          btn.classList.add('glass', 'text-white');
        }
      });
    }
    
    // 模态框控制
    function showRulesModal() {
      document.getElementById('rulesModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function hideRulesModal() {
      document.getElementById('rulesModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
    
    function showAdminModal() {
      document.getElementById('adminModal').classList.remove('hidden');
      document.getElementById('adminPassword').value = '';
      document.getElementById('passwordError').classList.add('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function hideAdminModal() {
      document.getElementById('adminModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
    
    // 密码验证
    function verifyPassword() {
      if (document.getElementById('adminPassword').value === 'root') {
        const now = Date.now();
        ['helmet', 'armor', 'gun'].forEach(type => {
          localStorage.setItem(`cooldown_${type}`, JSON.stringify({
            count: 3,
            resetTime: now + 3600000
          }));
        });
        localStorage.setItem('allLastUsed', '0');
        updateButtonStates();
        hideAdminModal();
        alert('所有冷却已重置');
      } else {
        document.getElementById('passwordError').classList.remove('hidden');
      }
    }
    
    // 图片路径映射
    const imagePaths = {
      helmet: './toukiu/toukiu (',
      armor: './hujia/huajia (',
      gun: './qiangxie/qiangxie ('
    };
    
    // 随机生成逻辑
    function getWeightedNum(max) {
      if (currentMode === 'random') {
        return Math.floor(Math.random() * max) + 1;
      }
      
      const weights = [];
      const midPoint = Math.floor(max / 2);
      
      for (let i = 1; i <= max; i++) {
        let weight = 1; // 基础权重
        
        if (currentMode === 'balanced') {
          // 均衡模式：中间区域权重更高
          const distance = Math.abs(i - midPoint);
          weight += Math.max(0, 3 - distance);
        } else if (currentMode === 'aggressive') {
          // 猛攻模式：高端区域权重更高
          const highThreshold = Math.floor(max * 0.6);
          if (i >= highThreshold) {
            weight += 3;
          }
        }
        
        weights.push({ num: i, weight });
      }
      
      // 更安全的随机选择
      const totalWeight = weights.reduce((sum, item) => sum + item.weight, 0);
      let random = Math.random() * totalWeight;
      
      for (const item of weights) {
        random -= item.weight;
        if (random <= 0) {
          return item.num;
        }
      }
      
      return weights[weights.length - 1].num; // 兜底
    }
    
    // 加载图片
    function loadImage(type, num) {
      const img = document.getElementById(`${type}Image`);
      const placeholder = document.getElementById(`${type}Placeholder`);
      const path = `${imagePaths[type]}${num}).png`;
      
      // 重置状态
      img.style.opacity = '0';
      placeholder.classList.remove('hidden');
      placeholder.innerHTML = `
        <i class="fa fa-spinner fa-spin text-5xl mb-3 text-neon"></i>
        <p class="text-gray-400/80 text-sm">加载中...</p>
      `;

      // 添加加载超时
      const timeout = setTimeout(() => {
        if (img.style.opacity === '0') { // 如果还没加载成功
          placeholder.innerHTML = `
            <i class="fa fa-exclamation-triangle text-5xl mb-3 text-yellow-400"></i>
            <p class="text-gray-400/80 text-sm">图片加载超时</p>
            <button onclick="loadImage('${type}', ${num})" class="mt-2 text-neon text-sm">
              <i class="fa fa-refresh"></i> 重试
            </button>
          `;
        }
      }, 5000);
      
      img.onload = () => {
        clearTimeout(timeout);
        placeholder.classList.add('hidden');
        // 淡入效果
        setTimeout(() => {
          img.style.opacity = '1';
        }, 50);
      };
      
      img.onerror = () => {
        clearTimeout(timeout);
        placeholder.innerHTML = `
          <i class="fa fa-image text-5xl mb-3 text-gray-400"></i>
          <p class="text-gray-400/80 text-sm">图片加载失败</p>
          <button onclick="loadImage('${type}', ${num})" class="mt-2 text-neon text-sm">
            <i class="fa fa-refresh"></i> 重试
          </button>
        `;
      };
      
      img.src = path;
    }
    
    // 单个刷新
    function randomizeSingle(type, max) {
      const storedKey = `cooldown_${type}`;
      let data;
      try {
        data = JSON.parse(localStorage.getItem(storedKey));
      } catch (e) {
        alert('数据读取错误，请刷新页面重试');
        return;
      }
      
      // 检查是否还有次数
      if (data.count <= 0) {
        updateButtonStates(); // 立即更新UI，显示倒计时
        return;
      }
      
      // 减少次数并保存
      data.count--;
      localStorage.setItem(storedKey, JSON.stringify(data));
      
      // 生成随机数并加载图片
      const num = getWeightedNum(max);
      loadImage(type, num);
      
      // 立即更新按钮状态
      updateButtonStates();
    }
    
    // 全部刷新
    function randomizeAll() {
      const now = Date.now();
      const allLastUsed = parseInt(localStorage.getItem('allLastUsed') || '0');
      
      // 检查冷却时间
      if (now - allLastUsed < 30000) {
        updateButtonStates(); // 立即更新UI，显示倒计时
        return;
      }
      
      // 记录使用时间
      localStorage.setItem('allLastUsed', now.toString());
      
      // 刷新护甲
      const armorNum = getWeightedNum(25);
      loadImage('armor', armorNum);
      
      // 150ms后刷新头盔
      setTimeout(() => {
        const helmetNum = getWeightedNum(25);
        loadImage('helmet', helmetNum);
      }, 150);
      
      // 300ms后刷新枪械
      setTimeout(() => {
        const gunNum = getWeightedNum(59);
        loadImage('gun', gunNum);
      }, 300);
      
      // 立即更新按钮状态
      updateButtonStates();
    }
    
    // 初始化
    window.onload = initStorage;
  </script>
</body>
</html>

